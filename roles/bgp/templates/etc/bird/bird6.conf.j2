# Don't log below error, else high risk of logspam through tons
# of 'seen` messages for routes
log syslog { error, fatal };

include "bird6/defines/*.conf";

table t_fulltable;
table t_as_set;
table t_ibgp;

router id ROUTER_ID;

include "bird6/filters/*.conf";

include "bird6/conf.d/*.conf";

protocol device { };

protocol kernel 'fulltable' {
  kernel table OWN_AS;
  table t_fulltable;
  export all;
  import none;
};

protocol kernel 'as-set' {
  kernel table 42;
  table t_as_set;
  export all;
  import none;
};

protocol pipe 'fulltable_to_as-set' {
  table t_fulltable;
  peer table t_as_set;
  # Table shall only contain routes we would also
  # export to a proper upstream
  export filter upstream_export_transitive;
  import none;
};

# Peer is provided with transit by us
template bgp 'bgp_downstream' {
  local as OWN_AS;
  table t_fulltable;
  import keep filtered;
  import filter downstream_import;
  export filter downstream_export;
}

# Peer is providing us with transit
template bgp 'bgp_upstream' {
  local as OWN_AS;
  table t_fulltable;
  import keep filtered;
  import filter upstream_import;
  export filter upstream_export;
}

# Peer is providing us with transit and we
# can provide that transit to our downstream peers
template bgp 'bgp_upstream_transitive' {
  local as OWN_AS;
  table t_fulltable;
  import keep filtered;
  import filter upstream_import;
  export filter upstream_export_transitive;
}

template bgp 'bgp_internal' {
  local as OWN_AS;
{% if bgp.route_reflection is defined and bgp.route_reflection %}
  {%- if bgp.route_reflection == 'off' %}
  {# Same as false and not defined, don't do anything #}
  {%- endif %}
  {%- if bgp.route_reflection == 'client' %}
  rr client;
  {%- endif %}
  {%- if bgp.route_reflection == 'server' %}
  rs client;
  {%- endif %}
  {%- if bgp.route_reflection | ipv4 %}
  rs client;
  rr cluster id {{ bgp.route_reflection }};
  {%- endif %}
{% endif %}
  table t_fulltable;
  import keep filtered;
  import filter ibgp_import;
  export filter ibgp_export;
}

include "bird6/peers/*.conf";
